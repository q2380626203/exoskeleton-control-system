# 登山外骨骼控制系统 V3

> 基于ESP32的智能登山外骨骼控制系统，通过BLE蓝牙实现实时参数调整和状态监控

## 🚀 项目特色

- **智能运动识别**：自动识别静止、行走、爬楼和大幅爬楼四种状态
- **多传感器融合**：电机位置 + GY25T陀螺仪 + GPS定位的三重融合检测
- **自适应助力**：根据运动状态提供分级助力输出
- **蓝牙控制**：通过BLE实现参数实时调整和状态监控
- **多阶段检测**：四阶段状态机确保可靠的静止检测和运动恢复

## 📋 系统架构

### 硬件组件
- **主控制器**：ESP32
- **电机系统**：2台小米CyberGear微电机（CAN转UART通信）
- **传感器**：GY25T三轴陀螺仪
- **定位模块**：GPS模块
- **通信接口**：蓝牙BLE

### 软件特性
- **实时操作系统**：基于FreeRTOS的多任务架构
- **通信协议**：BLE + UART双通道
- **运动算法**：多阶段检测 + 阶梯式力矩衰减
- **数据处理**：50点位置缓冲区 + 5点陀螺仪滑动窗口

## 🔧 核心功能

### 运动状态识别
| 状态 | 检测阈值 | 助力扭矩 | 说明 |
|------|----------|----------|------|
| 静止 | < 0.15弧度 | 0 Nm | 无助力输出 |
| 行走 | 0.15-0.6弧度 | 4.0 Nm | 平地行走助力 |
| 爬楼 | 0.6-1.0弧度 | 7.0 Nm | 爬楼助力 |
| 大幅爬楼 | > 1.0弧度 | 8.0 Nm | 高强度爬楼助力 |

### 多阶段检测系统
1. **正常运行期**：电机位置 + 陀螺仪双重检测
2. **强制静止期**：2秒力矩衰减 + 缓冲区清理
3. **恢复过渡期**：纯陀螺仪检测运动
4. **完全恢复期**：500ms恢复正常检测

### FreeRTOS任务优先级
```
UART接收解析 (优先级7) - 10ms
UART发送管理 (优先级6) - 10ms  
陀螺仪更新   (优先级4) - 100ms
GPS更新     (优先级3) - 200ms (NMEA解析+坐标转换)
运动分析     (优先级2) - 50ms
静止检测     (优先级1) - 100ms
```

## 📱 蓝牙控制协议

### BLE服务配置
- **服务UUID**: `4fafc201-1fb5-459e-8fcc-c5c9c331914b`
- **设备名称**: `ExoskeletonControl`

### 特征值
1. **参数特征** (`beb5483e-36e1-4688-b7f5-ea07361b26a8`): 接收参数调整
2. **电机数据特征** (`a8c8473c-1481-42a1-a734-71f3a223f3da`): 发送实时数据
3. **命令特征** (`da1a9a2a-e149-4f35-a768-2a1b5351336c`): 接收控制命令

### 参数调整指令示例
```json
{
  "type": "params",
  "ASSIST_TORQUE_WALK": 4.0,
  "ASSIST_TORQUE_CLIMB": 7.0,
  "INTERMITTENT_ENABLED": true
}
```

## ⚙️ 开发环境

### 硬件要求
- ESP32开发板
- 2台小米CyberGear微电机
- GY25T陀螺仪模块
- GPS模块（可选）
- CAN转UART模块

### 软件环境
- Arduino IDE 或 PlatformIO
- ESP32开发框架
- 依赖库：HardwareSerial, FreeRTOS

### 编译上传
1. 安装ESP32开发环境
2. 在Arduino IDE中打开`717.ino`
3. 选择ESP32开发板型号
4. 编译并上传程序

## 🔧 接口定义

### 电机通信 (UART1)
- **波特率**: 115200
- **引脚**: TX(GPIO13), RX(GPIO12)
- **协议**: CAN帧封装(12字节)

### 陀螺仪通信 (软串口)
- **波特率**: 115200  
- **引脚**: TX(GPIO1), RX(GPIO2)
- **数据帧**: 11字节固定格式

### GPS通信 (UART2)
- **波特率**: 9600
- **引脚**: TX(GPIO11), RX(GPIO10)  
- **协议**: NMEA 0183标准
- **支持格式**: GNRMC, GPRMC, GNGGA, GPGGA
- **坐标系**: WGS84转GCJ02(火星坐标系)

### GPS数据结构
```cpp
typedef struct {
    bool valid;              // 定位有效性
    double latitude;         // 纬度  
    double longitude;        // 经度
    float altitude;          // 海拔高度
    float speed;             // 移动速度
    int satellites;          // 卫星数量
    int fixQuality;          // 定位精度
    float hdop;              // 水平精度因子
    uint32_t lastUpdateTime; // 最后更新时间
} gps_position_t;
```

### 主要参数
```cpp
// 运动检测阈值
MOVEMENT_THRESHOLD_WALK: 0.15     // 行走检测
MOVEMENT_THRESHOLD_CLIMB: 0.6     // 爬楼检测  
MOVEMENT_THRESHOLD_CLIMB_STEEP: 1.0 // 大幅爬楼

// 助力扭矩设置
ASSIST_TORQUE_WALK: 4.0 Nm        // 行走助力
ASSIST_TORQUE_CLIMB: 7.0 Nm       // 爬楼助力
ASSIST_TORQUE_CLIMB_STEEP: 8.0 Nm // 大幅爬楼助力

// GPS配置参数
GPS_BAUDRATE: 9600               // GPS通信波特率
GPS_BUFFER_SIZE: 256             // GPS数据缓冲区
GPS_UPDATE_INTERVAL: 200ms       // GPS更新频率
```

## 🚀 性能特点

### 实时性
- 电机数据轮询: 10ms (交替5ms间隔)
- 运动分析: 50ms周期
- 静止检测: 100ms周期  
- 陀螺仪更新: 100ms周期

### 准确性
- 运动识别准确率: >95%
- 位置检测精度: ±0.01弧度
- 力矩衰减: 阶梯式递减避免冲击
- 双重静止确认: 位置+陀螺仪

### 节能优化
- 间歇式助力: 节能20-30%
- 智能力矩管理: 动态调整输出
- 静止自动失能: 避免无效消耗

## ⚠️ 故障排除

### 常见问题
1. **电机无响应**: 检查UART连接和电源
2. **识别不准确**: 调整检测阈值参数  
3. **助力异常**: 确认电机模式和参数配置

### 调试输出
系统启动时会打印详细的初始化信息，运行时输出电机状态、运动识别和力矩控制数据。

---

**登山外骨骼控制系统 V3** - 智能、高效、可靠的外骨骼控制解决方案